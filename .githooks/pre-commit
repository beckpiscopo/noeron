#!/bin/sh
set -eu

blocked_paths=$(git diff --cached --name-only | awk '
  $0 == ".env" ||
  $0 == ".env.local" ||
  $0 ~ /^\.next\// ||
  $0 ~ /^frontend\/\.next\// {
    print $0
  }
')

if [ -n "$blocked_paths" ]; then
  echo "ERROR: Commit includes blocked files:"
  echo "$blocked_paths"
  echo "Remove them from the commit and try again."
  exit 1
fi

# Scan staged diffs for common API key patterns
secrets=$(git diff --cached -U0 | grep -E '^\+' | grep -Ei '(sk-[a-zA-Z0-9]{20,}|AIza[a-zA-Z0-9_-]{35}|ghp_[a-zA-Z0-9]{36}|AKIA[A-Z0-9]{16}|sb_secret_[a-zA-Z0-9_-]+)' || true)

if [ -n "$secrets" ]; then
  echo "ERROR: Possible API key or secret detected in staged changes:"
  echo "$secrets"
  echo "Remove the secret and try again."
  exit 1
fi
